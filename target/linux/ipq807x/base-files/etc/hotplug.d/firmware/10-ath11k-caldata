#!/bin/sh

[ -e /lib/firmware/$FIRMWARE ] && exit 0

. /lib/functions.sh
. /lib/functions/system.sh

ath11k_generate_macs() {
	touch /lib/firmware/ath11k-macs
	eth=$(cat /sys/class/net/eth0/address)
	mac1=$(macaddr_add $eth 2)
	mac2=$(macaddr_add $eth 3)
	mac3=$(macaddr_add $eth 4)
	echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac3//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_eap101() {
	touch /lib/firmware/ath11k-macs
	eth=$(cat /sys/class/net/eth0/address)
	mac1=$(macaddr_add $eth 4)
	mac2=$(macaddr_add $eth 3)
	mac3=$(macaddr_add $eth 5)
	echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac3//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_wf194() {
	touch /lib/firmware/ath11k-macs
	mac=$(grep BaseMacAddress= /dev/mtd14 | cut -dx -f2)
	eth=$(macaddr_canonicalize $mac)
	mac1=$(macaddr_add $eth 2)
	mac2=$(macaddr_add $eth 3)
	mac3=$(macaddr_add $eth 4)
	echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac3//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_ion4x() {				     
	local dev=$(find_mtd_chardev "0:ART")
	touch /lib/firmware/ath11k-macs			   
	wifimac0=$(grep WLAN0_BASEMAC= $dev |cut -d '=' -f2) 
	wifimac1=$(grep WLAN1_BASEMAC= $dev |cut -d '=' -f2) 
	wifimac2=00:00:00:00:00:00				 
	echo -ne \\x${wifimac0//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${wifimac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${wifimac2//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_pax1800() {
	touch /lib/firmware/ath11k-macs
	eth=$(cat /sys/class/net/eth0/address)
	mac1=$(macaddr_add $eth 10)
	mac2=$(macaddr_add $eth 2)
	echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_wf660a() {
	touch /lib/firmware/ath11k-macs
	mmc_dev=$(find_mtd_chardev "0:APPSBLENV")
	[ -z "$mmc_dev" ] && mmc_dev=$(find_mmc_part "0:APPSBLENV")
	[ -n "$mmc_dev" ] && mac=$(grep BaseMacAddress= $mmc_dev | cut -dx -f2)
	eth=$(macaddr_canonicalize $mac)
	mac1=$(macaddr_add $eth 1)
	mac2=$(macaddr_add $eth 2)
	mac3=$(macaddr_add $eth 3)
	echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac3//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_wf186w() {
	touch /lib/firmware/ath11k-macs
	local dev=$(find_mtd_chardev "0:APPSBLENV")
	mac=$(grep BaseMacAddress= $dev | cut -dx -f2)
	eth=$(macaddr_canonicalize $mac)
	mac1=$(macaddr_add $eth 2)
	mac2=$(macaddr_add $eth 3)
	mac3=$(macaddr_add $eth 4)
	echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
	echo -ne \\x${mac3//:/\\x} >> /lib/firmware/ath11k-macs
}

ath11k_generate_macs_wf186h() {
        touch /lib/firmware/ath11k-macs
        local dev=$(find_mtd_chardev "0:APPSBLENV")
        mac=$(grep BaseMacAddress= $dev | cut -dx -f2)
        eth=$(macaddr_canonicalize $mac)
        mac1=$(macaddr_add $eth 2)
        mac2=$(macaddr_add $eth 3)
        mac3=$(macaddr_add $eth 4)
        echo -ne \\x${mac1//:/\\x} >> /lib/firmware/ath11k-macs
        echo -ne \\x${mac2//:/\\x} >> /lib/firmware/ath11k-macs
        echo -ne \\x${mac3//:/\\x} >> /lib/firmware/ath11k-macs
}


caldata_die() {
	echo "caldata: " "$*"
	exit 1
}

caldata_extract() {
	local part=$1
	local offset=$(($2))
	local count=$(($3))
	local mtd

	mtd=$(find_mtd_chardev $part)
	if [ -z "$mtd" ]; then
		mtd=/dev/$(echo $(find_mmc_part $part) | sed 's/^.\{5\}//')
	fi
	[ -n "$mtd" ] || caldata_die "no mtd device found for partition $part"

	dd if=$mtd of=/lib/firmware/$FIRMWARE iflag=skip_bytes bs=$count skip=$offset count=1 2>/dev/null || \
		caldata_die "failed to extract calibration data from $mtd"
}

board=$(board_name)

case "$FIRMWARE" in
"ath11k/IPQ6018/hw1.0/caldata.bin")
	case "$board" in
	bamboo-dynamics,bap6000|\
	pangu,l6018)
		caldata_extract "0:ART" 0x1000 0x20000
		;;
	esac
	;;
ath11k-macs)
	case "$board" in
	bamboo-dynamics,bap6000|\
	pangu,l6018)
		ath11k_generate_macs
	esac
	;;
*)
	exit 1
	;;
esac
